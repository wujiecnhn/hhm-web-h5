!function(){function e(e,t,o){$.ajax({type:"POST",url:e,data:t,timeout:15e3,success:function(e,t,n){-1===e.status?($.toast(e.msg,2e3),setTimeout(function(){location.href="/logout"},2e3)):e.status?o(null,e):o(e.msg,null)},error:function(t,n,r){console.error(e+" error: "+n+"##"+r),o("服务异常",null)}})}function t(t){e("/users/getStoreName",{},function(e,o){t(e,o.storeName)})}function o(t,o){var n={};return n.url=t,n.pageSize=o,n.pageId=0,n.addItems=function(t){var o=this;e(this.url,{pageId:this.pageId,pageSize:this.pageSize},function(e,n){e?t(e,null):(o.pageId++,t(null,n))})},n}function n(t,o,n,r){var a={};return a.url=t,a.pageSize=o,a.pageId=0,a.type=n,a.orderStatus=r,a.addItems=function(t){var o=this;e(this.url,{pageId:this.pageId,pageSize:this.pageSize,type:this.type,orderStatus:this.orderStatus},function(e,n){e?t(e,null):(o.pageId++,t(null,n))})},a}require.config({baseUrl:"../js",paths:{Vue:"./lib/vue.min",Utils:"./lib/utils.min"},shim:{Vue:{exports:"Vue"},Utils:{exports:"Utils"}}}),require(["Vue","Utils"],function(r,a){"use strict";r.config.delimiters=["${","}"],r.config.unsafeDelimiters=["{!!","!!}"],$(document).on("pageInit","#page-my",function(t,o,n){function a(){location.href="/users/go-to-report"}var i=new r({el:"#page-my",data:{storeName:"",level:"",message:0,headPic:""},methods:{buyReport:a}});e("/users/get-user-info",{},function(e,t){e||(i.storeName=t.user.EName,i.level=t.user.CustomerGroupName,i.headPic=t.user.HeadPicture)}),e("/users/get-notice-count",{},function(e,t){e||(i.message=t.count)})}),$(document).on("pageInit","#page-my-account",function(o,n,a){var i=new r({el:"#page-my-account",data:{storeName:"",headPic:""}});e("/users/get-user-info",{},function(e,t){e||(i.headPic=t.user.HeadPicture)}),t(function(e,t){e?$.toast(e,1e3):i.storeName=t});var s=function(t){e("/users/change-head",{headImg:t},function(e,t){e?cb(e,null):$("#headImg").attr("src",t.imgUrl)})};$(a).on("change","#linkHeader",function(){c(this.files[0],s)});var c=function(e,t){var o=e;if(!/image\/\w+/.test(o.type))return alert("请确保文件为图像类型"),!1;var n=new FileReader;n.onload=function(e){var o=new Image,n=95,r=document.createElement("canvas"),a=r.getContext("2d");o.onload=function(){r.width=n,r.height=n*(o.height/o.width),a.drawImage(o,0,0,r.width,r.height);var e=r.toDataURL(),i=e.split(",");t&&t(i[1])},o.src=this.result},n.readAsDataURL(o)};$(a).on("click","#linkName",function(){location.href="/users/change-shop-name"}),$(a).on("click","#linkAddress",function(){location.href="/users/my-address"}),$(a).on("click","#linkPassword",function(){location.href="/users/change-password"})}),$(document).on("pageInit","#page-change-shop-name",function(o,n,a){function i(t){s.isDisable||(e("/users/setStoreName",{storeName:s.storeName},function(e,t){$.hidePreloader(),e?$.toast(e,1e3):location.href="/users/account"}),$.showPreloader("保存中"))}var s=new r({el:"#page-change-shop-name",data:{storeName:""},computed:{isDisable:function(){return!this.storeName}},methods:{setStoreName:i}});t(function(e,t){e?$.toast(e,1e3):s.storeName=t})}),$(document).on("pageInit","#page-change-password",function(t,o,n){function a(t){if(!i.isDisable){if(i.newPW.length<6)return void $.toast("密码长度不能小于6位",1e3);if(i.newPW!=i.rePW)return void $.toast("密码输入不一致");e("/users/change-password",{newPassword:i.newPW,oldPassword:i.oldPW},function(e,t){$.hidePreloader(),e?$.toast(e,1e3):($.toast("新密码设置成功！",1e3),location.href="/users/account")}),$.showPreloader("保存中")}}var i=new r({el:"#page-change-password",data:{oldPW:"",newPW:"",rePW:""},computed:{isDisable:function(){return 0===this.oldPW.length||0===this.newPW.length||0===this.rePW.length}},methods:{changePW:a}})}),$(document).on("pageInit","#page-my-buy-report",function(e,t,o){function n(){var e=new Date(c.start).getTime(),t=new Date(c.end).getTime();location.href="/users/buy-report-result?p="+i.id+"!"+e+"!"+t}var i=a.getSearch(location);if(!i.id)return void(location.href="/");var s=a.dateFormat(new Date,"yyyy-MM-dd"),c=new r({el:"#page-my-buy-report",data:{start:s,end:s},methods:{query:n}});$("#my-start-time").calendar({value:[c.start],onChange:function(e,t,o){c.start=o}}),$("#my-end-time").calendar({value:[c.end],onChange:function(e,t,o){c.end=o}})}),$(document).on("pageInit","#page-my-buy-report-result",function(t,o,n){var i=a.getSearch(location);if(!i.p)return void(location.href="/");var s=i.p;if(s=s.split("!"),s.length<3)return void(location.href="/");var c=parseInt(s[0]),u=a.dateFormat(new Date(parseInt(s[1])),"yyyy-MM-dd"),d=a.dateFormat(new Date(parseInt(s[2])),"yyyy-MM-dd"),l=new r({el:"#page-my-buy-report-result",data:{reports:[]}});e("/users/buy-report-result",{userId:c,start:u,end:d},function(e,t){if(e);else{l.reports=a.clone(t.report);for(var o=0;o<l.reports.Items.length;o++){var n=l.reports.Items[o];$("#mytable").append('<tr><td width="50%">'+n.ProductName+'</td><td width="20%">'+n.Quantity+'</td><td width="30%">￥'+n.ProductAmount+"</td></tr>")}}})}),$(document).on("pageInit","#page-my-fav",function(t,n,i){function s(){location.href="/product/search?key="+encodeURI(encodeURI(m.searchWord))}function c(e){var t=m.favList[e],o=t.SkuList.filter(function(e){return e.IsSeckillProduct});o.length>0?location.href="/product/secKill-detail?id="+o[0].SeckillSysNo:location.href="/product/detail?id="+t.SysNo}function u(){e("/cart/get-count-in-cart",{},function(e,t){e||(m.cartNum=t.count)})}function d(){return""===h.addCartNum?(h.addCartNum=1,void $.toast("请输入正确的购买数量",1e3)):(e("/cart/add-to-cart",{productId:h.product.SysNo,skuId:h.curSkuId,qty:h.addCartNum},function(e,t){e?$.toast(e,1e3):u()}),void(h.addCartNum=1))}function l(e){h.product=m.favList[e],h.curSkuId=h.product.SkuList[0].SysNo,h.curPrice=h.product.SkuList[0].Price,h.curImg=h.product.SkuList[0].Images[0].ImgUrl,$.popup(".popup-cart")}function f(t){var o=m.favList[t];e(o.isLike?"/users/del-fav":"/users/add-fav",{productId:o.SysNo},function(e,t){$.hidePreloader(),e?$.toast(e,1e3):o.isLike=!o.isLike}),m.isLike?$.showPreloader("取消收藏..."):$.showPreloader("收藏...")}var m=new r({el:"#page-my-fav",data:{searchWord:"",cartNum:0,favList:[],count:0},methods:{addToFav:f,OpenCart:l,goToDetail:c,search:s}}),h=new r({el:"#popup-cart",data:{addCartNum:1,product:null,curPrice:0,curImg:"",curSkuId:0},methods:{addToCart:d}});u();var p=!1,g=new o("/users/my-fav",10);g.addItems(function(e,t){e?$.toast(e,1e3):(m.count=t.count,m.favList=m.favList.concat(t.favorite))}),$(i).on("infinite",".infinite-scroll-bottom",function(){p||(p=!0,setTimeout(function(){return p=!1,m.favList.length>=m.count?($.detachInfiniteScroll($(".infinite-scroll")),void $(".infinite-scroll-preloader").remove()):(g.addItems(function(e,t){e?$.toast(e,1e3):(m.count=t.count,m.favList=m.favList.concat(t.favorite))}),void $.refreshScroller())},1e3))}),$(i).on("click",".icon-clear",function(){m.searchWord=""}),h.$watch("addCartNum",function(e,t){""!==e&&(a.isPositiveNum(e)||($.toast("请输入正确的购买数量",500),r.nextTick(function(){h.addCartNum=t})))}),$(document).on("click",".icon-close.close-popup",function(){h.addCartNum=1}),$(document).on("click",".em-op-d",function(){h.addCartNum>1&&h.addCartNum--}),$(document).on("click",".em-op-a",function(){h.addCartNum++}),$(document).on("click",".my-ul-spec li",function(){$(".my-ul-spec li").removeClass("my-spec-on"),$(this).addClass("my-spec-on");var e=$(this).val(),t=h.product.SkuList[e];h.curSkuId=t.SysNo,h.curPrice=t.Price,h.curImg=t.Images[0].ImgUrl})}),$(document).on("pageInit","#page-my-message",function(t,n,a){function i(t){var o=s.notices[t];e("/users/set-notice-status",{noticeId:o.NoticeSysno},function(e,t){e||(o.IfRead=!0)}),$.modal({title:o.NoticeTitle+'<span class="my-message-time">'+o.InDate+"</span>",text:'<p class="my-dialog-content">'+o.NoticeContext+"<p>",extraClass:"my-dialog",buttons:[{text:'<a href="#" class="icon icon-close my-black-text"></a>'}]})}var s=new r({el:"#page-my-message",data:{notices:[]},methods:{openMsg:i}}),c=!1,u=new o("/users/my-message",20);u.addItems(function(e,t){e?$.toast(e,1e3):(s.count=t.count,s.notices=s.notices.concat(t.notices))}),$(a).on("infinite",".infinite-scroll-bottom",function(){c||(c=!0,setTimeout(function(){return c=!1,s.notices.length>=s.count?($.detachInfiniteScroll($(".infinite-scroll")),void $(".infinite-scroll-preloader").remove()):(u.addItems(function(e,t){e?$.toast(e,1e3):(s.count=t.count,s.notices=s.notices.concat(t.notices))}),void $.refreshScroller())},1e3))})}),$(document).on("pageInit","#page-my-address",function(t,o,n){function a(t,o){$.confirm("确定删除该地址吗?",function(){e("/address/del-receiver",{receiverId:i.receivers[t].receiverId},function(e,o){e?$.toast(e,1e3):i.receivers.splice(t,1)})},function(){})}var i=new r({el:"#page-my-address",data:{receivers:[],defaultIdx:null},methods:{deleteAdr:a}});e("/address/get-all-receiver",{},function(e,t){if(e)$.toast(e,1e3);else for(var o=t.receiver,n=o.length,r=0;n>r;r++){var a={};a.receiverId=o[r].SysNo,a.phone=o[r].ReceiverMobile,a.receiver=o[r].ReceiverName,a.pcdDes=o[r].Province+" "+o[r].City+" "+o[r].District+" "+o[r].Street,a.address=o[r].Address,a.isDefault=o[r].IsDefault,i.receivers.push(a)}}),$(n).on("change",'[name="single-radio"]',function(){e("/address/set-default-receiver",{receiverId:i.receivers[i.defaultIdx].receiverId},function(e,t){if($.hidePreloader(),e)$.toast(e,1e3);else for(var o=i.receivers.length,n=0;o>n;n++)n===i.defaultIdx?i.receivers[n].isDefault=!0:i.receivers[n].isDefault=!1}),$.showPreloader("保存中")})}),$(document).on("pageInit","#page-my-account",function(e,o,n){var a=new r({el:"#page-my-account",data:{storeName:""}});t(function(e,t){e?$.toast(e,1e3):a.storeName=t}),$(n).on("click","#linkName",function(){location.href="/users/change-shop-name"}),$(n).on("click","#linkAddress",function(){location.href="/users/my-address"}),$(n).on("click","#linkPassword",function(){location.href="/users/change-password"})}),$(document).on("pageInit","#page-my-book",function(t,o,a){function i(e,t){var o=null;o=0===t?d.orderListNow[e]:d.orderListAgo[e],location.href="/weixin/oauth?orderId="+o.OrderId+"&name="+o.ReceiverName,$.showPreloader("准备支付...")}function s(t,o){$.confirm("确定取消该订单吗?",function(){var n=null;n=0===o?d.orderListNow[t]:d.orderListAgo[t],e("/book/cancel",{orderId:n.OrderId},function(e,t){$.hidePreloader(),e?$.toast(e,1e3):(n.Status="已取消",n.statusNote="已取消",n.canCancel=!1,n.canPay=!1,n.reBuy=!0)}),$.showPreloader("取消订单")},function(){})}function c(t,o){var n=null;n=0===o?d.orderListNow[t]:d.orderListAgo[t],e("/book/rebuy",{orderId:n.OrderId},function(e,t){$.hidePreloader(),e?$.toast(e,1e3):($.toast("已加入购物车！",1e3),location.href="/cart/cart"),$.showPreloader("请稍等")})}function u(e){var t=0,o=null;for(t=0;t<e.orders.length;t++)o=e.orders[t],o.statusNote="",o.canCancel=!1,o.canPay=!1,o.reBuy=!1,"待审核"===o.Status||"待付款"===o.Status?"货到付款"!==o.PayMent&&0===o.PaymentStatus?(o.statusNote="待付款",o.canCancel=!0,o.canPay=!0):(o.statusNote="待审核",o.canCancel=!0):"待发货"===o.Status||"已发货"===o.Status?o.statusNote=o.Status:(o.statusNote=o.Status,o.reBuy=!0)}var d=new r({el:"#page-my-book",data:{orderListNow:[],orderListAgo:[],countNow:0,countAgo:0},methods:{payOrder:i,cancelOrder:s,reBuy:c}}),l=!1,f=new n("/users/my-book",10,0,0),m=new n("/users/my-book",10,1,0);f.addItems(function(e,t){$.hidePreloader(),e?$.toast(e,1e3):(d.countNow=t.count,u(t),d.orderListNow=d.orderListNow.concat(t.orders))}),m.addItems(function(e,t){e?$.toast(e,1e3):(d.countAgo=t.count,u(t),d.orderListAgo=d.orderListAgo.concat(t.orders))}),$.showPreloader("请稍等"),$(a).on("infinite",function(){if(!l){l=!0;var e=0;"tab1"==$(this).find(".infinite-scroll.active").attr("id")&&(e=0),"tab2"==$(this).find(".infinite-scroll.active").attr("id")&&(e=1),setTimeout(function(){return l=!1,d.orderListNow.length>=d.countNow?void $(".infinite-scroll-preloader").eq(e).hide():(0===e?f.addItems(function(e,t){e?$.toast(e,1e3):(d.countNow=t.count,u(t),d.orderListNow=d.orderListNow.concat(t.orders))}):m.addItems(function(e,t){e?$.toast(e,1e3):(d.countAgo=t.count,u(t),d.orderListAgo=d.orderListAgo.concat(t.orders))}),void $.refreshScroller())},1e3)}})}),$.init()})}();